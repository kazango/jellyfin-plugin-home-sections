<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Home Screen Sections</title>
</head>
<body>
<div data-role="page" id="homeScreenSectionsConfigurationPage" class="page type-interior pluginConfigurationPage fullWidthContent">
    <div class="content-primary">
        <div class="verticalSection">
            <div class="sectionTitleContainer">
                <h2 class="sectionTitle">Home Screen Sections</h2>
                <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;" target="_blank" href="https://github.com/IAmParadox27/jellyfin-plugin-home-sections">
                    <i class="md-icon button-icon button-icon-left secondaryText"></i>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <hr class="solid" style="margin-bottom: 1.5em;">
        <div style="margin-bottom: 1.5em;">
            <button class="jellyfin-tab-button active" data-tab="global" style="background: none; border: none; color: #fff; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid #fff; padding: 0.5em 1em;"><h3>Global Settings</h3></button>
            <button class="jellyfin-tab-button" data-tab="sections" style="background: none; border: none; color: #ccc; cursor: pointer; transition: color 0.3s, border-bottom 0.3s; border-bottom: 2px solid transparent; padding: 0.5em 1em;"><h3>Section Settings</h3></button>
        </div>

        <form class="artworkConfigurationForm">
            <div id="global" class="jellyfin-tab-content active" style="display: block;">
            <fieldset class="verticalSection-extrabottompadding">
                <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Default Settings</legend>
                <div style="padding-left: .5em;">
                    <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1.5em;">
                        <label class="emby-checkbox-label">
                            <input id="globalEnabledDefault" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                            <span>Enabled by Default</span>
                        </label>
                        <div class="fieldDescription">Enable Home Screen Sections by default for all users?</div>
                    </div>
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="globalAllowUserOverride" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                            <span>Allow User Override</span>
                        </label>
                        <div class="fieldDescription">Can users enable/disable this plugin for their own view?</div>
                    </div>
                </div>
            </fieldset>

            <fieldset class="verticalSection-extrabottompadding">
                <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Upcoming Section Settings</legend>
                <div style="padding-left: .5em;">
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="upcomingShowsTimeframeValue">Upcoming Shows Timeframe</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input is="emby-input" type="number" id="upcomingShowsTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                            <select is="emby-select" id="upcomingShowsTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                                <option value="Months">Months</option>
                                <option value="Years">Years</option>
                            </select>
                        </div>
                        <div class="fieldDescription">How far in the future should we look for upcoming episodes?</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="upcomingMoviesTimeframeValue">Upcoming Movies Timeframe</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input is="emby-input" type="number" id="upcomingMoviesTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                            <select is="emby-select" id="upcomingMoviesTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                                <option value="Months">Months</option>
                                <option value="Years">Years</option>
                            </select>
                        </div>
                        <div class="fieldDescription">How far in the future should we look for upcoming movies?</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="upcomingMusicTimeframeValue">Upcoming Music Timeframe</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input is="emby-input" type="number" id="upcomingMusicTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                            <select is="emby-select" id="upcomingMusicTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                                <option value="Months">Months</option>
                                <option value="Years">Years</option>
                            </select>
                        </div>
                        <div class="fieldDescription">How far in the future should we look for upcoming music releases?</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="upcomingBooksTimeframeValue">Upcoming Books Timeframe</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input is="emby-input" type="number" id="upcomingBooksTimeframeValue" min="1" max="999" style="flex: 0 0 100px;" />
                            <select is="emby-select" id="upcomingBooksTimeframeUnit" class="emby-select-withcolor emby-select" style="flex: 0 0 120px;">
                                <option value="Days">Days</option>
                                <option value="Weeks">Weeks</option>
                                <option value="Months">Months</option>
                                <option value="Years">Years</option>
                            </select>
                        </div>
                        <div class="fieldDescription">How far in the future should we look for upcoming book releases?</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="dateFormat">Date Format</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select is="emby-select" id="dateFormat" class="emby-select-withcolor emby-select" style="flex: 0 0 150px;">
                                <option value="YYYY/MM/DD">YYYY/MM/DD</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM">DD/MM</option>
                                <option value="MM/DD">MM/DD</option>
                            </select>
                            <input is="emby-input" type="text" id="dateDelimiter" maxlength="3" style="flex: 0 0 60px;" placeholder="/" />
                        </div>
                        <div class="fieldDescription">How should dates be displayed?</div>
                    </div>
                </div>
            </fieldset>

                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Advanced Settings</legend>
                    <div style="padding-left: .5em;">
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">*arr API Settings</summary>
                            <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtSonarrUrl" label="Sonarr URL" />
                                    <div class="fieldDescription">Complete URL for Sonarr to use for upcoming shows sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtSonarrApiKey" label="Sonarr API Key" />
                                    <div class="fieldDescription">API Key for Sonarr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtRadarrUrl" label="Radarr URL" />
                                    <div class="fieldDescription">Complete URL for Radarr to use for upcoming movies sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtRadarrApiKey" label="Radarr API Key" />
                                    <div class="fieldDescription">API Key for Radarr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtLidarrUrl" label="Lidarr URL" />
                                    <div class="fieldDescription">Complete URL for Lidarr to use for upcoming music sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtLidarrApiKey" label="Lidarr API Key" />
                                    <div class="fieldDescription">API Key for Lidarr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtReadarrUrl" label="Readarr URL" />
                                    <div class="fieldDescription">Complete URL for Readarr to use for upcoming books sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtReadarrApiKey" label="Readarr API Key" />
                                    <div class="fieldDescription">API Key for Readarr instance.</div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">LibreTranslate</summary>
                            <div style="padding-top: 1em;">
                                 <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtLibreTranslateUrl" label="LibreTranslate URL" />
                                    <div class="fieldDescription">URL for LibreTranslate instance to use for translations.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtLibreTranslateApiKey" required="required" label="LibreTranslate API Key" />
                                    <div class="fieldDescription">API Key for LibreTranslate instance.</div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Jellyseerr</summary>
                             <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtJellyseerrUrl" label="Jellyseerr URL" />
                                    <div class="fieldDescription">URL for Jellyseerr to use for Discover sections.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="password" data-id="txtJellyseerrApiKey" required="required" label="Jellyseerr API Key" />
                                    <div class="fieldDescription">API Key for Jellyseerr instance.</div>
                                </div>
                                <div class="inputContainer">
                                    <input is="emby-input" type="text" data-id="txtJellyseerrPreferredLanguages" required="required" label="Discover Sections Language Filter" />
                                    <div class="fieldDescription">Preferred languages to filter for Discover section. (comma delimited)</div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Default Libraries</summary>
                            <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultMoviesLibrary">Default Movies Library</label>
                                    <select is="emby-select" id="defaultMoviesLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific movies library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultTVShowsLibrary">Default TV Shows Library</label>
                                    <select is="emby-select" id="defaultTVShowsLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific TV shows library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultMusicLibrary">Default Music Library</label>
                                    <select is="emby-select" id="defaultMusicLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific music library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultMusicVideosLibrary">Default Music Videos Library</label>
                                    <select is="emby-select" id="defaultMusicVideosLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific music videos library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                                <div class="inputContainer">
                                    <label class="inputLabel inputLabelUnfocused" for="defaultBooksLibrary">Default Books Library</label>
                                    <select is="emby-select" id="defaultBooksLibrary" class="emby-select-withcolor emby-select">
                                        <option value="">Default</option>
                                    </select>
                                    <div class="fieldDescription">Select the specific books library to use for navigation. Lists all underlying library folders (not grouped views).<br><strong>Requires Jellyfin restart to take effect.</strong></div>
                                </div>
                            </div>
                        </details>
                        <details style="margin-bottom: 1em;">
                            <summary style="cursor: pointer; font-weight: bold;">Cache</summary>
                            <div style="padding-top: 1em;">
                                <div class="inputContainer">
                                    <input is="emby-input" type="number" data-id="txtCacheTimeoutSeconds" label="Cache Timeout (seconds)" min="0" max="604800" />
                                    <div class="fieldDescription">How long browsers should cache plugin resources (default: 86400 = 24 hours). Set to 0 to disable caching.</div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary style="cursor: pointer; font-weight: bold;">Third-Party Integrations</summary>
                            <div style="padding-top: 1em;">
                                <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1.5em;">
                                    <label class="emby-checkbox-label">
                                        <input id="globalStreamyfinHomeOverride" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                                        <span>Override Streamyfin Home</span>
                                    </label>
                                    <div class="fieldDescription">Should requests for the Streamyfin config overwrite the home section with a Home Screen Sections generation.<br /><br/><i>Please Note: This functionality behind this setting is currently highly experimental and more work is likely needed before this is finalised.</i></div>
                                </div>
                            </div>
                        </details>
                    </div>
                </fieldset>

                <fieldset class="verticalSection-extrabottompadding">
                    <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Developer Settings</legend>
                    <div style="padding-left: .5em;">
                        <div class="checkboxContainer checkboxContainer-withDescription" style="margin-bottom: 1.5em;">
                            <label class="emby-checkbox-label">
                                <input id="globalDeveloperMode" type="checkbox" is="emby-checkbox" class="emby-checkbox">
                                <span>Developer Mode</span>
                            </label>
                            <div class="fieldDescription">Disable browser caching for plugin resources during development.</div>
                        </div>
                        <div style="margin-top: 1em;">
                            <div style="display: flex; gap: 1em; align-items: center; flex-wrap: wrap;">
                                <button type="button" id="btnBustHomeSectionsCache" class="raised button-submit emby-button">
                                    <span>Bust Static Assets Cache</span>
                                </button>
                                <button type="button" id="btnBustAllCaches" class="raised emby-button" style="background-color: #2196F3;">
                                    <span>Bust All Caches (Assets + Index)</span>
                                </button>
                                <span id="cacheBustStatus" style="color: #52b54b; display: none; font-weight: bold;"></span>
                            </div>
                            <div style="margin-top: 0.5em; font-size: 0.9em; color: #ccc;">
                                <strong>Static Assets Cache:</strong> Clears browser cache for CSS/JS files only.<br>
                                <strong>All Caches:</strong> Clears both static assets and index.html transformation cache.
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div id="sections" class="jellyfin-tab-content" style="display: none;">
                <fieldset class="verticalSection-extrabottompadding">
                     <legend style="padding-bottom:10px; font-weight: bolder; font-size: 1.2em;">Field Descriptions</legend>
                    <ul style="margin: 0; padding-left: 1.5em;">
                        <li><strong>Order:</strong>  Sets the display order for this section in Jellyfin. Lower numbers appear first. <i>Note: Sections with the same number are shown in random order among themselves</i></li>
                        <li><strong>Enabled:</strong> Enable this section by default</li>
                        <li><strong>User Override:</strong> Let the user override this section</li>
                        <li><strong>Lower Limit (Min):</strong> The minimum number of times this section should appear</li>
                        <li><strong>Upper Limit (Max):</strong> The maximum number of times this section can appear</li>
                        <li><strong>View Mode:</strong> Defines the card layout used when displaying results.<i>If disabled, the section only supports the displayed layout.</i></li>
                    </ul>
                </fieldset>
                <div style="overflow-x: auto;">
                <table id="sectionsTable" class="tblConnections" style="width: 100%;">
                    <thead>
                        <tr>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Section</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Order</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Enabled</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">User Override</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Hide Watched</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Min</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">Max</th>
                            <th style="text-align: center; vertical-align: middle; padding: 8px 12px; font-weight: bold;">View Mode</th>
                        </tr>
                    </thead>
                    <tbody id="sectionWrapper">
                    </tbody>
                </table>
                </div>
            </div>

            <br>
            <button id="btnSaveConfig" is="emby-button" type="submit" class="raised button-submit block emby-button">
                <span>Save</span>
            </button>
        </form>
    </div>

    <template id="sectionConfigTemplate">
        <tr data-id="section-config">
            <td style="text-align: left; vertical-align: middle; padding: 8px 12px;">
                <input type="hidden" data-id="hiddenSectionId" />
                <strong data-id="lblSectionName"></strong>
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <input data-id="txtOrderIndex" type="number" is="emby-input" min="0" class="emby-input" style="width: 60px; display: inline-table; text-align: center;">
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <label style="width: 0;" class="emby-checkbox-label">
                    <input data-id="chkSectionEnabled" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                    <span class="checkboxLabel"></span>
                    <span class="checkboxOutline">
                        <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                        <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                    </span>
                </label>
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <label style="width: 0;" class="emby-checkbox-label">
                    <input data-id="chkSectionUserOverrideAllowed" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                    <span class="checkboxLabel"></span>
                    <span class="checkboxOutline">
                        <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                        <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                    </span>
                </label>
            </td>
                        <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <label style="width: 0;" class="emby-checkbox-label">
                    <input data-id="chkHideWatchedItems" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                    <span class="checkboxLabel"></span>
                    <span class="checkboxOutline">
                        <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                        <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                    </span>
                </label>
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <input data-id="txtSectionMinLimit" type="number" is="emby-input" min="0" class="emby-input" style="width: 60px; display: inline-table; text-align: center;">
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <input data-id="txtSectionMaxLimit" type="number" is="emby-input" min="0" class="emby-input" style="width: 60px; display: inline-table; text-align: center;">
            </td>
            <td style="text-align: center; vertical-align: middle; padding: 8px 12px;">
                <select is="emby-select" class="emby-select-withcolor emby-select" data-id="viewModeSelect" style="width: fit-content; text-align: center;">
                    <option value="Portrait">Portrait</option>
                    <option value="Landscape">Landscape</option>
                    <option value="Square">Square</option>
                    <option value="Small">Small</option>
                </select>
            </td>
        </tr>
    </template>

    <script type="text/javascript">
        (() => {
            // Plugin GUID for configuration API
            const pluginId = 'b8298e01-2697-407a-b44d-aa8dc795e850';
            // Plugin assembly name for transformation cache system
            const pluginAssemblyName = 'Jellyfin.Plugin.HomeScreenSections';

            // Centralized Arr service configuration
            const arrServiceConfigs = [
                { name: 'Sonarr', timeframePrefix: 'upcomingShows', defaultValue: 1, defaultUnit: 'Weeks' },
                { name: 'Radarr', timeframePrefix: 'upcomingMovies', defaultValue: 3, defaultUnit: 'Months' },
                { name: 'Lidarr', timeframePrefix: 'upcomingMusic', defaultValue: 6, defaultUnit: 'Months' },
                { name: 'Readarr', timeframePrefix: 'upcomingBooks', defaultValue: 1, defaultUnit: 'Years' }
            ];

            function createArrConfig(serviceConfig) {
                const timeframeValueSelector = '#' + serviceConfig.timeframePrefix + 'TimeframeValue';
                return {
                    Url: document.querySelector('[data-id=txt' + serviceConfig.name + 'Url]').value,
                    ApiKey: document.querySelector('[data-id=txt' + serviceConfig.name + 'ApiKey]').value,
                    UpcomingTimeframeValue: parseInt(document.querySelector(timeframeValueSelector).value) || serviceConfig.defaultValue,
                    UpcomingTimeframeUnit: document.querySelector('#' + serviceConfig.timeframePrefix + 'TimeframeUnit').value
                };
            }

            function loadArrConfig(serviceConfig, config) {
                const arrConfig = config[serviceConfig.name];
                const timeframeValueSelector = '#' + serviceConfig.timeframePrefix + 'TimeframeValue';
                const timeframeUnitSelector = '#' + serviceConfig.timeframePrefix + 'TimeframeUnit';
                
                document.querySelector('[data-id=txt' + serviceConfig.name + 'Url]').value = arrConfig?.Url || '';
                document.querySelector('[data-id=txt' + serviceConfig.name + 'ApiKey]').value = arrConfig?.ApiKey || '';
                document.querySelector(timeframeValueSelector).value = arrConfig?.UpcomingTimeframeValue || serviceConfig.defaultValue;
                document.querySelector(timeframeUnitSelector).value = arrConfig?.UpcomingTimeframeUnit || serviceConfig.defaultUnit;
            }

            function setupTabs() {
                const tabs = document.querySelectorAll('.jellyfin-tab-button');
                const tabContents = document.querySelectorAll('.jellyfin-tab-content');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => {
                            t.classList.remove('active');
                            t.style.color = '#ccc';
                            t.style.borderBottom = '2px solid transparent';
                        });
                        tab.classList.add('active');
                        tab.style.color = 'var(--primary-accent-color, #fff)';
                        tab.style.borderBottom = '2px solid var(--primary-accent-color, #fff)';
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                            content.style.display = 'none';
                        });
                        const activeTab = document.getElementById(tab.dataset.tab);
                        activeTab.classList.add('active');
                        activeTab.style.display = 'block';
                    });
                });
            }

            function addSectionSetting(sectionConfig, sectionInfo) {
                const sectionWrapper = document.querySelector('#sectionWrapper');
                const template = document.querySelector('#sectionConfigTemplate').content.cloneNode(true);

                template.querySelector('[data-id=hiddenSectionId]').value = sectionConfig.SectionId;
                template.querySelector('[data-id=lblSectionName]').innerHTML = sectionInfo.DisplayText;
                template.querySelector('[data-id=chkSectionEnabled]').checked = sectionConfig.Enabled;
                template.querySelector('[data-id=chkSectionUserOverrideAllowed]').checked = sectionConfig.AllowUserOverride;
                template.querySelector('[data-id=txtSectionMinLimit]').value = sectionConfig.LowerLimit;
                template.querySelector('[data-id=txtSectionMaxLimit]').value = sectionConfig.UpperLimit;
                template.querySelector('[data-id=txtOrderIndex]').value = sectionConfig.OrderIndex;

                const viewModeSelect = template.querySelector('[data-id=viewModeSelect]');
                viewModeSelect.value = sectionConfig.ViewMode;
                if (!sectionInfo.AllowViewModeChange) {
                    viewModeSelect.value = sectionInfo.ViewMode;
                    viewModeSelect.setAttribute('disabled', true);
                }

                const hideWatchedCheckbox = template.querySelector('[data-id=chkHideWatchedItems]');
                const hideWatchedLabel = hideWatchedCheckbox.closest('.emby-checkbox-label');
                hideWatchedCheckbox.checked = sectionConfig.HideWatchedItems
                if (!sectionInfo.AllowHideWatched && hideWatchedLabel) {
                    hideWatchedCheckbox.setAttribute('disabled', true);
                    hideWatchedLabel.style.opacity = '0.5';
                    hideWatchedLabel.style.cursor = 'default';
                }

                sectionWrapper.appendChild(template);
            }

            function loadLibraries() {
                window.ApiClient.getVirtualFolders().then(function (result) {
                    const moviesSelect = document.querySelector('#defaultMoviesLibrary');
                    const tvShowsSelect = document.querySelector('#defaultTVShowsLibrary');
                    const musicSelect = document.querySelector('#defaultMusicLibrary');
                    const musicVideosSelect = document.querySelector('#defaultMusicVideosLibrary');
                    const booksSelect = document.querySelector('#defaultBooksLibrary');

                    moviesSelect.innerHTML = '<option value="">Default</option>';
                    tvShowsSelect.innerHTML = '<option value="">Default</option>';
                    musicSelect.innerHTML = '<option value="">Default</option>';
                    musicVideosSelect.innerHTML = '<option value="">Default</option>';
                    booksSelect.innerHTML = '<option value="">Default</option>';

                    result.forEach(function (folder) {
                         if (folder.CollectionType === 'movies' || folder.CollectionType === 'tvshows' || folder.CollectionType === 'music' || folder.CollectionType === 'musicvideos' || folder.CollectionType === 'books') {
                             const option = document.createElement('option');
                            let folderId = folder.ItemId;
                            if (folderId && !folderId.includes('-')) {
                                folderId = folderId.replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/, '$1-$2-$3-$4-$5');
                            }
                            option.value = folderId;
                            option.textContent = folder.Name;

                            if(folder.CollectionType === 'movies') moviesSelect.appendChild(option);
                            if(folder.CollectionType === 'tvshows') tvShowsSelect.appendChild(option);
                            if(folder.CollectionType === 'music') musicSelect.appendChild(option);
                            if(folder.CollectionType === 'musicvideos') musicVideosSelect.appendChild(option);
                            if(folder.CollectionType === 'books') booksSelect.appendChild(option);
                        }
                    });
                }).catch(function (error) {
                    console.error('Failed to load libraries:', error);
                });
            }

            function saveConfig(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                const config = {
                    Enabled: document.querySelector('#globalEnabledDefault').checked,
                    AllowUserOverride: document.querySelector('#globalAllowUserOverride').checked,
                    LibreTranslateUrl: document.querySelector('[data-id=txtLibreTranslateUrl]').value,
                    LibreTranslateApiKey: document.querySelector('[data-id=txtLibreTranslateApiKey]').value,
                    JellyseerrUrl: document.querySelector('[data-id=txtJellyseerrUrl]').value,
                    JellyseerrApiKey: document.querySelector('[data-id=txtJellyseerrApiKey]').value,
                    JellyseerrPreferredLanguages: document.querySelector('[data-id=txtJellyseerrPreferredLanguages]').value,
                    DefaultMoviesLibraryId: document.querySelector('#defaultMoviesLibrary').value,
                    DefaultTVShowsLibraryId: document.querySelector('#defaultTVShowsLibrary').value,
                    DefaultMusicLibraryId: document.querySelector('#defaultMusicLibrary').value,
                    DefaultMusicVideosLibraryId: document.querySelector('#defaultMusicVideosLibrary').value,
                    DefaultBooksLibraryId: document.querySelector('#defaultBooksLibrary').value,
                    ...Object.fromEntries(arrServiceConfigs.map(serviceConfig => [
                        serviceConfig.name, 
                        createArrConfig(serviceConfig)
                    ])),
                    DateFormat: document.querySelector('#dateFormat').value,
                    DateDelimiter: document.querySelector('#dateDelimiter').value,
                    DeveloperMode: document.querySelector('#globalDeveloperMode').checked,
                    CacheTimeoutSeconds: document.querySelector('[data-id=txtCacheTimeoutSeconds]').value || 86400,
                    OverrideStreamyfinHome: document.querySelector('#globalStreamyfinHomeOverride').checked,
                    SectionSettings: []
                };

                document.querySelectorAll('#sectionWrapper tr').forEach(row => {
                    const sectionConfig = {
                        SectionId: row.querySelector('[data-id=hiddenSectionId]').value,
                        Enabled: row.querySelector('[data-id=chkSectionEnabled]').checked,
                        AllowUserOverride: row.querySelector('[data-id=chkSectionUserOverrideAllowed]').checked,
                        LowerLimit: row.querySelector('[data-id=txtSectionMinLimit]').value,
                        UpperLimit: row.querySelector('[data-id=txtSectionMaxLimit]').value,
                        OrderIndex: row.querySelector('[data-id=txtOrderIndex]').value,
                        ViewMode: row.querySelector('[data-id=viewModeSelect]').value,
                        HideWatchedItems: row.querySelector('[data-id=chkHideWatchedItems]').checked,
                    };
                    config.SectionSettings.push(sectionConfig);
                });

                window.ApiClient.updatePluginConfiguration(pluginId, config)
                    .then(Dashboard.processPluginConfigurationUpdateResult)
                    .catch(e => console.error(e))
                    .finally(() => Dashboard.hideLoadingMsg());
            }

            function loadConfig() {
                Dashboard.showLoadingMsg();
                window.ApiClient.getPluginConfiguration(pluginId)
                    .then(function (config) {
                        document.querySelector('#globalEnabledDefault').checked = config.Enabled;
                        document.querySelector('#globalAllowUserOverride').checked = config.AllowUserOverride;
                        document.querySelector('[data-id=txtLibreTranslateUrl]').value = config.LibreTranslateUrl;
                        document.querySelector('[data-id=txtLibreTranslateApiKey]').value = config.LibreTranslateApiKey;
                        document.querySelector('[data-id=txtJellyseerrUrl]').value = config.JellyseerrUrl;
                        document.querySelector('[data-id=txtJellyseerrApiKey]').value = config.JellyseerrApiKey;
                        document.querySelector('[data-id=txtJellyseerrPreferredLanguages]').value = config.JellyseerrPreferredLanguages;
                        
                        arrServiceConfigs.forEach(serviceConfig => {
                            loadArrConfig(serviceConfig, config);
                        });
                        document.querySelector('#dateFormat').value = config.DateFormat || 'YYYY/MM/DD';
                        document.querySelector('#dateDelimiter').value = config.DateDelimiter || '/';

                        document.querySelector('#globalStreamyfinHomeOverride').checked = config.OverrideStreamyfinHome;
                        document.querySelector('#globalDeveloperMode').checked = config.DeveloperMode;
                        document.querySelector('[data-id=txtCacheTimeoutSeconds]').value = config.CacheTimeoutSeconds || 86400;

                        setTimeout(function() {
                            if (config.DefaultMoviesLibraryId) {
                                document.querySelector('#defaultMoviesLibrary').value = config.DefaultMoviesLibraryId;
                            }
                            if (config.DefaultTVShowsLibraryId) {
                                document.querySelector('#defaultTVShowsLibrary').value = config.DefaultTVShowsLibraryId;
                            }
                            if (config.DefaultMusicLibraryId) {
                                document.querySelector('#defaultMusicLibrary').value = config.DefaultMusicLibraryId;
                            }
                            if (config.DefaultMusicVideosLibraryId) {
                                document.querySelector('#defaultMusicVideosLibrary').value = config.DefaultMusicVideosLibraryId;
                            }
                            if (config.DefaultBooksLibraryId) {
                                document.querySelector('#defaultBooksLibrary').value = config.DefaultBooksLibraryId;
                            }
                        }, 500);

                        window.ApiClient.ajax({
                            url: ApiClient.getUrl('ModularHomeViews/Sections'),
                            type: 'GET'
                        }).then(response => response.json()).then(function (json) {
                            json.Items.forEach(sectionType => {
                                let sectionConfig = config.SectionSettings.find(s => s.SectionId === sectionType.Section);
                                if (!sectionConfig) {
                                    sectionConfig = {
                                        SectionId: sectionType.Section,
                                        Enabled: true,
                                        AllowUserOverride: true,
                                        LowerLimit: 1,
                                        UpperLimit: sectionType.Limit,
                                        ViewMode: sectionType.ViewMode,
                                        OrderIndex: 999,
                                        HideWatchedItems: false
                                    };
                                }
                                addSectionSetting(sectionConfig, sectionType);
                            });
                        }).finally(() => Dashboard.hideLoadingMsg());
                    });
            }

            document.querySelector('#homeScreenSectionsConfigurationPage').addEventListener("pageshow", function () {
                setupTabs();
                loadLibraries();
                loadConfig();
                document.querySelector('#btnSaveConfig').addEventListener("click", saveConfig);

                // Cache bust functionality
                const btnBustHomeSectionsCache = document.querySelector('#btnBustHomeSectionsCache');
                const btnBustAllCaches = document.querySelector('#btnBustAllCaches');
                const cacheBustStatus = document.getElementById('cacheBustStatus');

                function showStatus(message, isError = false) {
                    if (cacheBustStatus) {
                        cacheBustStatus.textContent = message;
                        cacheBustStatus.style.color = isError ? '#d32f2f' : '#52b54b';
                        cacheBustStatus.style.display = 'inline';
                        setTimeout(() => cacheBustStatus.style.display = 'none', 4000);
                    }
                }

                function setButtonState(button, loading, originalText) {
                    button.disabled = loading;
                    button.querySelector('span').textContent = loading ? 'Busting Cache...' : originalText;
                }

                if (btnBustHomeSectionsCache) {
                    const originalText = btnBustHomeSectionsCache.querySelector('span').textContent;
                    btnBustHomeSectionsCache.addEventListener('click', function() {
                        setButtonState(btnBustHomeSectionsCache, true, originalText);

                        window.ApiClient.ajax({
                            url: window.ApiClient.getUrl('HomeScreen/BustCache'),
                            type: 'POST',
                            dataType: 'json',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            showStatus('Static assets cache busted successfully');
                        }).catch(error => {
                            console.error('Static assets cache bust error:', error);
                            showStatus('Failed to bust static assets cache', true);
                        }).finally(() => {
                            setButtonState(btnBustHomeSectionsCache, false, originalText);
                        });
                    });
                }

                if (btnBustAllCaches) {
                    const originalText = btnBustAllCaches.querySelector('span').textContent;
                    btnBustAllCaches.addEventListener('click', function() {
                        setButtonState(btnBustAllCaches, true, originalText);
                        
                        // First bust static assets cache (Home Sections)
                        const staticAssetsPromise = window.ApiClient.ajax({
                            url: window.ApiClient.getUrl('HomeScreen/BustCache'),
                            type: 'POST',
                            dataType: 'json',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });

                        // Then bust index.html transformation cache (for home-sections plugin assembly name)
                        const indexTransformPromise = window.ApiClient.ajax({
                            url: window.ApiClient.getUrl('TransformationCache/bust-cache?pluginName=' + encodeURIComponent(pluginAssemblyName)),
                            type: 'POST',
                            dataType: 'json',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });

                        Promise.allSettled([staticAssetsPromise, indexTransformPromise])
                            .then(results => {
                                const staticResult = results[0];
                                const transformResult = results[1];
                                
                                let message = '';
                                let isError = false;
                                
                                if (staticResult.status === 'fulfilled' && transformResult.status === 'fulfilled') {
                                    message = 'All caches busted successfully (assets + index)';
                                } else if (staticResult.status === 'fulfilled' && transformResult.status === 'rejected') {
                                    console.warn('Transformation cache bust failed:', transformResult.reason);
                                    if (transformResult.reason?.status === 404) {
                                        message = 'Static assets cache busted - file-transformation plugin not found or plugin not registered';
                                    } else {
                                        message = 'Static assets cache busted - file-transformation cache failed (check console)';
                                    }
                                } else if (staticResult.status === 'rejected') {
                                    console.error('Static assets cache bust failed:', staticResult.reason);
                                    message = 'Failed to bust static assets cache';
                                    isError = true;
                                } else {
                                    message = 'Cache bust completed with mixed results (check console)';
                                }
                                
                                showStatus(message, isError);
                            }).finally(() => {
                                setButtonState(btnBustAllCaches, false, originalText);
                            });
                    });
                }
            });
        })();
    </script>
</div>
</body>
</html>
